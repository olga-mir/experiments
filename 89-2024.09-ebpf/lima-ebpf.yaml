minimumLimaVersion: "1.0.0"

# https://github.com/lima-vm/lima/blob/e41a769b31f20cec65d85b16b0d71b11fe8a7a13/templates/ubuntu-24.10.yaml
images:
# - location: "https://cloud-images.ubuntu.com/releases/24.10/release-20241212/ubuntu-24.10-server-cloudimg-arm64.img"
#  arch: "aarch64"
#  digest: "sha256:fb39312ffd2b47b97eaef6ff197912eaa3e0a215eb3eecfbf2a24acd96ee1125"
- location: "https://cloud-images.ubuntu.com/releases/24.10/release-20241212/ubuntu-24.10-server-cloudimg-amd64.img"
  arch: "x86_64"
  digest: "sha256:457f02ad36ef64f8f2cbfcc4855a0d401294d9b4727ae239e21c4104cca0bae2"

arch: "x86_64"
vmType: "qemu"

cpus: 4
memory: "8GiB"

mounts:
  - location: "~"
    writable: true
  - location: "/tmp/lima"
    writable: true

hostResolver:
  enabled: true
  ipv6: false

provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail

    # System packages
    apt-get update
    apt-get install -y \
      apt-transport-https \
      clang \
      llvm \
      libelf-dev \
      libpcap-dev \
      libbfd-dev \
      binutils-dev \
      build-essential \
      make \
      linux-tools-common \
      linux-tools-$(uname -r) \
      linux-headers-generic \
      linux-libc-dev \
      bpfcc-tools

# TODO - test if this works
# - mode: system
#   script: |
#     #!/bin/bash
#     set -eux -o pipefail
#     command -v docker >/dev/null 2>&1 && exit 0
#     export DEBIAN_FRONTEND=noninteractive
#     curl -fsSL https://get.docker.com | sh
#     systemctl disable --now docker
#     apt-get install -y uidmap dbus-user-session

containerd:
  system: false
  # TODO - `false` was not tested, but with `true` there are conflicts when installing docker
  #system: true
  user: false

portForwards:
  - guestSocket: "/var/run/docker.sock"
    hostSocket: "{{.Dir}}/docker.sock"

# TODO - this may eliminate the need to run gcloud to push the image from inside the lima
# while it works, it is more cumbersome and in current setup auth config is not great.
# docker:
#   socketPath: /var/run/docker.sock

