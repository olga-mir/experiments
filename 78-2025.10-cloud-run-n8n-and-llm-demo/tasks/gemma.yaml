version: '3'

vars:
  PROJECT_ID:
    sh: echo "${PROJECT_ID:?'PROJECT_ID environment variable is required'}"
  NETWORK:
    sh: echo "${NETWORK:?'NETWORK environment variable is required'}"
  SUBNETWORK:
    sh: echo "${SUBNETWORK:?'SUBNETWORK environment variable is required'}"
  ZONE:
    sh: echo "${ZONE:?'ZONE environment variable is required'}"

  # Gemma service configuration
  GEMMA_SERVICE_NAME: gemma-model
  GEMMA_SA_NAME: gemma-service
  GEMMA_SERVICE_ACCOUNT: 'gemma-service@{{.PROJECT_ID}}.iam.gserviceaccount.com'
  GEMMA_REGION: asia-southeast1

tasks:
  deploy:
    desc: Deploy Gemma LLM model to Cloud Run
    cmds:
      - ../scripts/deploy-gemma.sh

  get-url:
    desc: Get gemma service URL
    cmds:
      - gcloud run services describe {{.GEMMA_SERVICE_NAME}} --region={{.GEMMA_REGION}} --format='value(status.url)'

  delete:
    desc: Delete gemma Cloud Run service
    cmds:
      - gcloud run services delete {{.GEMMA_SERVICE_NAME}} --region={{.GEMMA_REGION}} --quiet

  proxy:
    desc: Start Cloud Run proxy for gemma (access on http://localhost:8080)
    cmds:
      - echo "Starting Cloud Run proxy for gemma on http://localhost:8080"
      - echo "Press Ctrl+C to stop"
      - gcloud beta run services proxy {{.GEMMA_SERVICE_NAME}} --region={{.GEMMA_REGION}} --project={{.PROJECT_ID}}

  bastion-copy-test:
    desc: Copy gemma test script to bastion host
    cmds:
      - echo "Copying test-gemma.sh to bastion..."
      - gcloud compute scp ../scripts/test-gemma.sh bastion:~ --project={{.PROJECT_ID}} --zone={{.ZONE}} --tunnel-through-iap
      - echo ""
      - echo "Script copied to bastion:~/test-gemma.sh"
      - echo "To use on bastion:"
      - echo "  export GEMMA_URL=\$$(gcloud run services describe {{.GEMMA_SERVICE_NAME}} --region={{.GEMMA_REGION}} --format='value(status.url)')"
      - echo "  ./test-gemma.sh \"Your question here\""

  bastion-test:
    desc: Run gemma test from bastion host
    vars:
      GEMMA_URL:
        sh: gcloud run services describe {{.GEMMA_SERVICE_NAME}} --region={{.GEMMA_REGION}} --format='value(status.url)'
      PROMPT: '{{.PROMPT | default "Hello, how are you?"}}'
    cmds:
      - echo "Testing Gemma service from bastion..."
      - gcloud compute ssh bastion --project={{.PROJECT_ID}} --zone={{.ZONE}} --tunnel-through-iap --command="export GEMMA_URL={{.GEMMA_URL}} && ~/test-gemma.sh '{{.PROMPT}}'"
